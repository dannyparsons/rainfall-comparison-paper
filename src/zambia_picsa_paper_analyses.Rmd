---
title: "PICSA Paper Analyses"
author: "Danny Parsons"
date: "01/08/2020"
output: 
  html_document:
    fig_width: 12
    fig_height: 6
---

```{r packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(here)
library(ggplot2)
library(lubridate)
library(reshape2)
library(viridis)
library(RColorBrewer)
library(tidyr)
library(hydroGOF)
library(stringr)
library(knitr)
library(kableExtra)
library(rnaturalearthdata)
library(rnaturalearth)
library(ggrepel)
library(sp)
library(tibble)
library(purrr)
library(dplyr)
```

```{r setup, include=FALSE}
source(here("src", "helper_funs.R"))

zm <- readRDS(here("data", "station", "cleaned", "zambia_gridded.RDS")) %>%
  dplyr::select(-(arc2_rain))
# 1 Aug = 214
s_doy_start <- 214
zm <- zm %>% 
  mutate(doy = yday_366(date),
         s_doy = (doy - s_doy_start + 1) %% 366,
         s_doy = ifelse(s_doy == 0, 366, s_doy),
         syear = year,
         syear = ifelse(s_doy > (366 - s_doy_start + 1), syear - 1, syear),
         month = factor(month, levels = c(8:12, 1:7)),
         month_abb = factor(month, labels = month.abb[c(8:12, 1:7)]),
         rain = ifelse(rain < 0, 0, rain),
         era5_rain = ifelse(era5_rain < 0, 0, era5_rain)
         ) %>%
  filter(year >= 1983)

# Not using ENACTS for most analyses so remove.
zm$enacts_rain <- NULL

zm_long_st <- zm %>% 
  melt(id.vars = c("station", "date", "year", "syear", "month", "month_abb", 
                   "doy", "s_doy", "rain"),
       measure.vars = names(zm)[endsWith(names(zm), "rain")][-1],
       variable.name = "product", value.name = "pr_rain")

zm_long_st$product <- factor(zm_long_st$product, 
                          levels = c("chirps_rain", "era5_rain", "tamsat_rain",
                                     "imerg_rain", "rfe2_rain"))
zm_long <- zm %>% 
  melt(id.vars = c("station", "date", "year", "syear", "month", "month_abb", "doy", "s_doy"),
       measure.vars = names(zm)[endsWith(names(zm), "rain")],
       variable.name = "product", value.name = "rain") %>%
  mutate(rainday = rain > 1)

zm_long$product <- recode(zm_long$product, rain = "station")
zm_long$product <- factor(zm_long$product, 
                          levels = c("station", "chirps_rain", "era5_rain", "tamsat_rain",
                                     "imerg_rain", "rfe2_rain"))
stations <- c("Kasama", "Mansa", "Mpika", "Magoye", "Moorings", "Choma", "Livingstone")
products <- levels(zm_long$product)
products <- products[-1]
names(products) <- substr(products, 1, nchar(products) - 5)

metadata_station <- readRDS(here("data", "station", "processed", "stations_metadata.RDS"))
metadata_zm <- metadata_station %>%
  filter(country == "Zambia")
rm(metadata_station)

metadata_zm$station <- factor(metadata_zm$station, levels = stations)
zm_long$station <- factor(zm_long$station, levels = stations)

by_station <- zm_long %>%
  group_by(station) %>%
  filter(!is.na(rain) & product == "station") %>%
  summarise(first_date = first(date),
            last_date = last(date))

metadata_zm <- left_join(metadata_zm, by_station, by = "station")

rm(by_station)

metadata_zm <- metadata_zm %>% arrange(station)

zm_long <- left_join(zm_long, metadata_zm, by = "station")

zm_long <- zm_long %>% 
  filter(date >= first_date & date <= last_date)

skable <- function(kable_input) {
  kable_input %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                                full_width = FALSE)
}
```

## Stations

- Kasama, Mansa, Mpika in the North. 
- Mansa results are different to the results in the south, which could be the location or the quality of the station
- Station data filtered to start in 1983 to align with majority of products

```{r}
metadata_zm %>% 
  mutate(period = paste(year(first_date), "-", year(last_date))) %>%
  select(station, latitude, longitude, period) %>%
  kable(digits = 2) %>%
  skable()
```

```{r prop_complete_days}
zm %>% 
  group_by(station) %>% 
  summarise(prop_n = 100* (1 - naflex::na_prop(rain))) %>%
  kable(digits = 1) %>%
  skable()
```

```{r gof_fun}
dgof <- function(df, sim, obs, na.rm = TRUE) {
  g <- hydroGOF::gof(sim = df[[sim]], obs = df[[obs]], na.rm = na.rm)
  as.list(g[ ,1])
}

comp_stats <- c("ME", "r", "PBIAS %", "MAE", "rSD", "KGE")
names(comp_stats) <- c("Mean bias (same units)",
                       "Correlation coefficient (1 = Perfect)",
                       "Percentage bias (%)",
                       "Mean absolute bias (same units)",
                       "Ratio of standard deviations (< 1 less variable, > 1 more variable)",
                       "Kling-Gupta efficiency")

comp_stats_digits <- c(0, 2, 0, 0, 2, 2, 2)
```

## Yearly Comparisons (August to July)

```{r yearly_calcs}
by_syear <- zm_long %>%
  group_by(station, syear, product) %>%
  summarise(total_rain = sum(naif_nmin(rain, 355)), 
            n_rain = sum(naif_nmin(rain, 355) >= 0.85), 
            max_rain = max(naif_nmin(rain, 350)), 
            mean_rain = total_rain/n_rain, 
            n_na = sum(is.na(rain))
            )

by_syear_st <- by_syear %>%
  pivot_wider(id_cols = c(station, syear), 
              names_from = product, values_from = total_rain:n_na, names_sep = "__") %>%
  pivot_longer(cols = -c(station, syear, ends_with("station")), 
               names_to = c(".value", "product"), names_sep = "__")

gof_syear <- by_syear_st %>%
  group_by(station, product) %>%
  nest() %>%
  mutate(n = purrr::map_int(data, 
                        ~sum(!is.na(.$total_rain__station) & !is.na(.$total_rain))),
         gof__total_rain = purrr::map(data, dgof, "total_rain", "total_rain__station", 
                                      na.rm = TRUE),
         gof__n_rain = purrr::map(data, dgof, "n_rain", "n_rain__station", na.rm = TRUE),
         gof__mean_rain = purrr::map(data, dgof, "mean_rain", "mean_rain__station", 
                                     na.rm = TRUE)
         )

gof_pr <- gof_syear %>% 
  unnest(cols = data) %>% 
  group_by(product) %>% 
  nest()
```

```{r yearly_plots_fun}
yearly_plots <- function(df, gof_col, stat_pr, stat_st, product_name, title, ytitle) {
  max_y <- max(c(df[[stat_pr]], df[[stat_st]]), na.rm = TRUE)
  product_name <- toupper(substr(product_name, 1, nchar(product_name) - 5))
  vals_relace <- c(product_name, "Gauge")
  names(vals_relace) <- c("pr", "st")
  df <- df %>% 
    mutate(pr = ifelse(is.na(.data[[stat_st]]), NA, .data[[stat_pr]]),
           st = ifelse(is.na(.data[[stat_pr]]), NA, .data[[stat_st]])) %>%
    select(-c(stat_st, stat_pr))
  dat <- df %>%
    pivot_longer(cols = c("pr", "st"), names_to = "Source", values_to = stat_pr) %>%
    mutate(Source = recode(Source, !!!vals_relace),
           Source = factor(Source, levels = c("Gauge", product_name)),
           ME = purrr::map_dbl(.data[[gof_col]], "ME"),
           r = purrr::map_dbl(.data[[gof_col]], "r"),
           rSD = purrr::map_dbl(.data[[gof_col]], "rSD")
           )
  mean_df <- dat %>% 
    group_by(station, Source) %>% 
    summarise(m = mean(.data[[stat_pr]], na.rm = TRUE))
  g <- ggplot(dat, aes(x = syear, y = .data[[stat_pr]], colour = Source)) +
    geom_line() +
    geom_point() +
    geom_hline(data = mean_df, aes(yintercept = m, colour = Source)) +
    scale_x_continuous(breaks = seq(1980, 2015, 5), limits = c(1978, 2017), expand = c(0, 0)) +
    scale_y_continuous(limits = c(0, NA)) +
    labs(x = "Year", y = ytitle) +
    # n
    # geom_text(data = dat, aes(label = paste("n", n)), size = 4,
    #           x = 1983, y = max_y, na.rm = TRUE, 
    #           inherit.aes = FALSE) +
    # # bias
    # geom_text(data = dat, aes(label = paste("bias", signif(ME, 2))), 
    #           size = 4, x = 1983 + 6, y = max_y, na.rm = TRUE, 
    #           inherit.aes = FALSE) +
    # # cor
    # geom_text(aes(label = paste("cor", round(r, 2))), 
    #           size = 4, x = 1983 + 12, y = max_y, na.rm = TRUE, 
    #           inherit.aes = FALSE) +
    # # rSD
    # geom_text(aes(label = paste("rSD", round(rSD, 2))), 
    #           size = 4, x = 1983 + 18, y = max_y, na.rm = TRUE, 
    #           inherit.aes = FALSE) +
    ggtitle(paste0("Gauge vs ", product_name, " ", title)) +
    facet_wrap(~station)
  g
}
```

```{r stats_tables_fun}
stats_tables <- function(df, obj_col, obj_stats = comp_stats) {
  for(i in seq_along(obj_stats)) {
    dat <- df %>% 
      ungroup() %>%
      mutate(purrr::map_dbl(df[[obj_col]], obj_stats[i]))
    names(dat)[ncol(dat)] <- obj_stats[i]
    dat <- dat %>% 
      mutate(station = as.character(station)) %>%
      pivot_wider(id_cols = "station", names_from = "product", 
                  values_from = obj_stats[i]) %>%
      data.frame()
    names(dat)[2:ncol(dat)] <- toupper(substr(names(dat)[2:ncol(dat)], 1, nchar(names(dat)[2:ncol(dat)]) - 5))
  #dat[nrow(dat) + 1, ] <- c(list("(All)"), as.list(as.numeric(colMeans(dat[ , -1]))))
    dat %>%
      kable(digits = comp_stats_digits[i], caption = names(obj_stats[i]),
            format.args = list(big.mark = ",")) %>%
      skable() %>%
      #row_spec(nrow(dat), bold = TRUE) %>%
      print()
  }
}
```

### Comparison Statistics for Total Yearly Rainfall

- In general all products follow a similar shape each year (high correlation)
- All products, apart from ERA5, estimate the mean quite well (low bias and low percentage bias).
- ERA5 overestimates (high bias) but could be expected as it represents the largest area.
- RFE2 and IMERG look promising across all measures, but few years compared, need the extended station records for better comparison
- Aside from RFE2 and IMERG, CHIRPS performs well over all measures
- Slightly less variability in all products, between 70% - 90% (apart from RFE2 which has roughly the same variability)
- Results for Mansa are generally different across products, indicating possible issues with the station records

```{r yearly_total_plots}
p_syear_total <- gof_pr %>%
  mutate(p = purrr::map(data, yearly_plots, gof_col = "gof__total_rain", 
                        stat_pr = "total_rain", stat_st = "total_rain__station", 
                        product_name = product, ytitle = "Total Rainfall (mm/year)",
                        title = "August to July total rainfall (mm/year)"),
         paths = here("results",  
                      paste0("zambia_", "syear_", "total_rain", "_", product, ".png")))

##! Figure zm_tamsat_total and zm_era5_total (Section 4.3.2.1)
walk2(p_syear_total$paths, p_syear_total$p, ggsave, width = 12, height = 6)
```

```{r yearly_total_tamsat_era5}
yearly_tamsat <- gof_pr$data[[3]] %>%
  dplyr::select(station, syear, Gauge = total_rain__station, 
                TAMSAT = total_rain)
yearly_era5 <- gof_pr$data[[2]] %>%
  dplyr::select(station, syear, ERA5 = total_rain)
yearly_tamsat_era5 <- full_join(yearly_tamsat, yearly_era5, 
                                by = c("station", "syear"))
yearly_tamsat_era5 <- yearly_tamsat_era5 %>%
    mutate(TAMSAT = ifelse(is.na(Gauge), NA, TAMSAT),
           ERA5 = ifelse(is.na(Gauge), NA, ERA5))
dat <- yearly_tamsat_era5 %>%
    pivot_longer(cols = all_of(c("Gauge", "TAMSAT", "ERA5")), 
                 names_to = "Source", values_to = "total_rain", 
                 names_ptypes = list(
                   Source = factor(levels = c("Gauge", "TAMSAT", "ERA5"))))
mean_df <- dat %>%
  group_by(station, Source) %>%
  summarise(m = mean(total_rain, na.rm = TRUE))
  g <- ggplot(dat, aes(x = syear, y = total_rain, colour = Source)) +
    geom_line() +
    geom_point() +
    geom_hline(data = mean_df, aes(yintercept = m, colour = Source)) +
    scale_x_continuous(breaks = seq(1980, 2015, 5), 
                       limits = c(1978, 2017), expand = c(0, 0)) +
    scale_y_continuous(limits = c(0, NA)) +
    scale_colour_manual(values = c("black", c25[1:2])) +
    labs(x = "Year", y = "Total Rainfall (mm/year)") +
    ggtitle("Gauge vs TAMSAT vs ERA5 August to July total rainfall (mm/year)") +
    facet_wrap(~station)
##! Possible alternative to figure zm_tamsat_total and zm_era5_total (Section 4.3.2.1)
  ggsave(here("results", "zambia_syear_total_rain_tamsat_era5.png"),
         g, width = 12, height = 6)
```

```{r yearly_n_obs, results="asis"}
dat <- gof_syear %>% 
  select(station, product, n) %>%
  pivot_wider(id_cols = c(station), names_from = product, values_from = n)

names(dat)[endsWith(names(dat), "rain")] <- 
  substr(names(dat)[endsWith(names(dat), "rain")], 
         1, nchar(names(dat)[endsWith(names(dat), "rain")]) - 5)

##! Table zm_nyears (Section 4.3.2.1)
dat %>%
  kable(caption = "Number of years compared") %>%
  skable()
```

```{r yearly_total_rain_tables, results="asis"}
#stats_tables(gof_syear, "gof__total_rain")
df <- gof_syear %>%
  ungroup() %>%
  mutate(r = purrr::map_dbl(gof__total_rain, "r"),
         pbias = purrr::map_dbl(gof__total_rain, "PBIAS %"),
         rSD = purrr::map_dbl(gof__total_rain, "rSD"),
         KGE = purrr::map_dbl(gof__total_rain, "KGE")) %>%
  pivot_longer(cols = c("r", "pbias", "rSD", "KGE"), names_to = "metric") %>%
  mutate(metric = factor(metric, levels = c("r", "pbias", "rSD", "KGE"))) %>%
  select(station, product, metric, value) %>%
  mutate(value = ifelse(metric == "pbias", round(value), 
                        format(value, digits = 2))) %>%
  pivot_wider(names_from = "product", values_from = "value") %>%
  arrange(metric, station)
names(df)[3:ncol(df)] <- toupper(substr(names(df)[3:ncol(df)], 1, 
                                        nchar(names(df)[3:ncol(df)]) - 5))
##! Table zm_total_metrics (Section 4.3.2.1)
df %>% 
  select(metric, station, CHIRPS, ERA5, TAMSAT, IMERG, RFE2) %>%
  kable() %>%
  column_spec(column = 5, border_right = TRUE) %>%
  collapse_rows(columns = 1) %>%
  skable()
```

### Comparison Statistics for Number of rainy days

- Reasonably good correlation across the products, so similar pattern each year
- All products overestimate number of rainy days with the same threshold
- Wide variation of the bias amount across products, ERA5 has largest bias, CHIPS has lowest
- Almost the same variability for all products
- Results for Mansa are generally different across products, indicating possible issues with the station records

```{r liv_yearly_n_rain_plots}
liv_year <- gof_pr %>% 
  unnest(data) %>%
  filter(station == "Livingstone") %>%
  select(product, station, syear, n_rain__station, n_rain) %>%  
  mutate(n_rain__station = ifelse(is.na(n_rain), NA, n_rain__station),
         n_rain = ifelse(is.na(n_rain__station), NA, n_rain)) %>%
  pivot_longer(cols = c("n_rain__station", "n_rain"), 
               names_to = "Source", values_to = "n_rain") %>%
  ungroup() %>%
  mutate(Source = forcats::fct_recode(Source, 
                                      Gauge = "n_rain__station", Estimate = "n_rain"),
         Source = factor(Source, levels = c("Gauge", "Estimate")),
         product = toupper(substr(product, 1, nchar(product) - 5)),
         product = factor(product, levels = c("CHIRPS", "ERA5", "TAMSAT", "IMERG", "RFE2")))

mean_df <- liv_year %>%
  group_by(product, Source) %>%
  summarise(m = mean(n_rain, na.rm = TRUE))

g <- ggplot(liv_year, aes(x = syear, y = n_rain, colour = Source)) +
  geom_line() +
  geom_point() +
  geom_hline(data = mean_df, aes(yintercept = m, colour = Source)) +
  scale_x_continuous(breaks = seq(1980, 2015, 5), limits = c(1978, 2017), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "Year", y = "Rain day (> 0.85) frequency (rain day/year)") +
  ggtitle("Gauge vs estimate August to July rain day frequency at Livingstone") +
  facet_wrap(~product)
g
##! Figure zm_liv_n (Section 4.3.2.1)
ggsave(here("results", paste0("zambia_", "livingstone_", "n_rain", ".png")),
       width = 12, height = 6)
```

```{r liv_yearly_n_rain_tables, results="asis"}
# stats_tables(gof_syear, "gof__n_rain")
df <- gof_syear %>%
  filter(station == "Livingstone") %>%
  ungroup() %>%
  mutate(r = purrr::map_dbl(gof__n_rain, "r"),
         pbias = purrr::map_dbl(gof__n_rain, "PBIAS %"),
         MAE = purrr::map_dbl(gof__n_rain, "MAE")) %>%
  pivot_longer(cols = c("r", "pbias", "MAE"), names_to = "metric") %>%
  mutate(metric = factor(metric, levels = c("r", "pbias", "MAE"))) %>%
  select(station, product, metric, value) %>%
  mutate(value = ifelse(metric == "r", format(value, digits = 2), 
                        round(value))) %>%
  pivot_wider(names_from = "product", values_from = "value") %>%
  arrange(metric, station)
names(df)[3:ncol(df)] <- toupper(substr(names(df)[3:ncol(df)], 1, 
                                        nchar(names(df)[3:ncol(df)]) - 5))
##! Table zm_liv_n_metric (Section 4.3.2.1)
df %>% 
  select(metric, CHIRPS, ERA5, TAMSAT, IMERG, RFE2) %>%
  kable() %>%
  column_spec(column = 4, border_right = TRUE) %>%
  collapse_rows(columns = 1) %>%
  skable()
```

```{r liv_yearly_mean_rain_plots}
liv_year <- gof_pr %>% 
  unnest(data) %>%
  filter(station == "Livingstone") %>%
  select(product, station, syear, mean_rain__station, mean_rain) %>%  
  mutate(mean_rain__station = ifelse(is.na(mean_rain), NA, mean_rain__station),
         mean_rain = ifelse(is.na(mean_rain__station), NA, mean_rain)) %>%
  pivot_longer(cols = c("mean_rain__station", "mean_rain"), 
               names_to = "Source", values_to = "mean_rain") %>%
  ungroup() %>%
  mutate(Source = forcats::fct_recode(Source, 
                                      Gauge = "mean_rain__station", Estimate = "mean_rain"),
         Source = factor(Source, levels = c("Gauge", "Estimate")),
         product = toupper(substr(product, 1, nchar(product) - 5)),
         product = factor(product, levels = c("CHIRPS", "ERA5", "TAMSAT", "IMERG", "RFE2")))

mean_df <- liv_year %>%
  group_by(product, Source) %>%
  summarise(m = mean(mean_rain, na.rm = TRUE))

g <- ggplot(liv_year, aes(x = syear, y = mean_rain, colour = Source)) +
  geom_line() +
  geom_point() +
  geom_hline(data = mean_df, aes(yintercept = m, colour = Source)) +
  scale_x_continuous(breaks = seq(1980, 2020, 5), limits = c(1978, 2017), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "Year", y = "Mean rain intensity (mm/rain day)") +
  ggtitle("Gauge vs estimate August to July mean rain intensity at Livingstone") +
  facet_wrap(~product)
g
##! Figure zm_liv_mean (Section 4.3.2.1)
ggsave(here("results", paste0("zambia_", "livingstone_", "mean_rain", ".png")),
       width = 12, height = 6)
```

## Zero order Markov Chain models

```{r markov_chain_setup}
zambia_markov <- zm_long_st %>% 
  filter(!is.na(rain) & !is.na(pr_rain)) %>%
  mutate(rainday1 = rain > 0.85,
         pr_rainday1 = pr_rain > 0.85,
         pr_rainday2 = pr_rain > 2,
         pr_rainday3 = pr_rain > 3,
         pr_rainday4 = pr_rain > 4,
         pr_rainday5 = pr_rain > 5,
         pr_rainday2max = pr_rain > 1 & pr_rain <= 2,
         pr_rainday3max = pr_rain > 1 & pr_rain <= 3,
         pr_rainday4max = pr_rain > 1 & pr_rain <= 4,
         pr_rainday5max = pr_rain > 1 & pr_rain <= 5)

f_zero_order_station <- rainday1 ~ (cos(s_doy * 1 * 2 * pi/366) +
                                    sin(s_doy * 1 * 2 * pi/366) + 
                                    cos(s_doy * 2 * 2 * pi/366) + 
                                    sin(s_doy * 2 * 2 * pi/366) +
                                    cos(s_doy * 3 * 2 * pi/366) +
                                    sin(s_doy * 3 * 2 * pi/366))
f_zero_order_product <- update.formula(f_zero_order_station, pr_rainday1 ~ .)

predict_stack_lst <- list()
for(s in seq_along(stations)) {
  predict_df <- data.frame(station = stations[s], s_doy = 1:366,
                           s_doy_date = as.Date(1:366, origin = as.Date("1999/07/31")))
  dat <- zambia_markov %>%
    filter(station == stations[s])
  for(i in seq_along(products)) {
    dat_prod <- dat %>%
      filter(product %in% c("station", products[i])) %>% 
      filter(!is.na(rain) & !is.na(pr_rain))
    zero_order_station <- glm(f_zero_order_station, data = dat_prod, 
                              family = binomial)
    zero_order_product <- glm(f_zero_order_product, data = dat_prod, 
                              family = binomial)
    predict_df[[paste0("station", "_", products[i])]] <-
      predict(zero_order_station, newdata = predict_df, type = "response")
    predict_df[[products[i]]] <- 
      predict(zero_order_product, newdata = predict_df, type = "response")
    
    f_zero_order_product_2thres <- update.formula(f_zero_order_station,
                                                  pr_rainday2 ~ .)
    f_zero_order_product_3thres <- update.formula(f_zero_order_station, 
                                                  pr_rainday3 ~ .)
    f_zero_order_product_4thres <- update.formula(f_zero_order_station, 
                                                  pr_rainday4 ~ .)
    f_zero_order_product_5thres <- update.formula(f_zero_order_station, 
                                                  pr_rainday5 ~ .)
    f_zero_order_product_2max <- update.formula(f_zero_order_station, 
                                                pr_rainday2max ~ .)
    f_zero_order_product_3max <- update.formula(f_zero_order_station, 
                                                pr_rainday3max ~ .)
    f_zero_order_product_4max <- update.formula(f_zero_order_station, 
                                                pr_rainday4max ~ .)
    f_zero_order_product_5max <- update.formula(f_zero_order_station, 
                                                pr_rainday5max ~ .)
    fms <- list(f_zero_order_product_2max, f_zero_order_product_3max, 
                f_zero_order_product_4max, f_zero_order_product_5max)
    fms_thres <- list(f_zero_order_product_2thres, f_zero_order_product_3thres,
                      f_zero_order_product_4thres, f_zero_order_product_5thres)
    mds <- list()
    for(j in 3:(3 + length(fms_thres) - 1)) {
      zero_order <- glm(fms_thres[[j - 2]], data = dat_prod, family = binomial)
      predict_df[[paste0(products[i], "_", j, "thres")]] <- 
        predict(zero_order, newdata = predict_df, type = "response")
    }
  }
  
  predict_stack <- predict_df %>% 
    melt(id.vars = c("station", "s_doy", "s_doy_date"),
         variable.name = "product", value.name = "prob")

  predict_stack$product <- as.character(predict_stack$product)
  predict_stack$product2 <- predict_stack$product
  predict_stack$type <- "product1"
  
  predict_stack <- predict_stack %>% 
    mutate(type = ifelse(startsWith(product, "station"), "station1", type),
           type = ifelse(endsWith(product, "max"), 
                         substr(product, nchar(product) - 3, nchar(product)), 
                         type),
           type = ifelse(endsWith(product, "thres"), 
                         substr(product, nchar(product) - 5, nchar(product)), 
                         type),
           product2 = ifelse(startsWith(product, "station"), 
                             substr(product, 9, nchar(product)), product2),
           product2 = ifelse(endsWith(product, "max"), 
                             substr(product, 1, nchar(product) - 5), product2),
           product2 = ifelse(endsWith(product, "thres"), 
                             substr(product, 1, nchar(product) - 7), product2)
           )
  
  predict_stack$type <- factor(predict_stack$type, 
                               levels = unique(predict_stack$type))
  predict_stack_lst[[length(predict_stack_lst) + 1]] <- predict_stack
}
predict_stack_all <- bind_rows(predict_stack_lst)
predict_stack_all$station <- factor(predict_stack_all$station, levels = stations)
```

```{r markov_chain_plots_products}
types <- c("Gauge > 0.85mm", " > 0.85mm",
           " > 2mm", " > 3mm",
           " > 4mm", " > 5mm")
for(s in seq_along(products)) {
  curve_labs <- paste0(c("", rep(toupper(names(products)[s]), 5)), types)
  dat <- predict_stack_all %>% 
    filter(product2 == products[s] & !grepl("max", type))
  g <- ggplot(dat, aes(x = s_doy_date, y = prob, 
                       colour = type, size = type, linetype = type)) +
    geom_line() +
    facet_wrap(~station) +
    scale_color_manual(values = c("black", viridis(5, end = 0.8)),
                       labels = curve_labs, name = "Curve") +
    scale_size_manual(values = c(1.3, rep(0.8, 5)), 
                      labels = curve_labs, name = "Curve") +
    scale_x_date(date_breaks = "2 months", date_labels = "%b", name = "Date") +
    scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), 
                       name = "Rain day frequency (rain days/day)") +
    scale_linetype_manual(values = c("solid", rep("longdash", 5)), 
                          labels = curve_labs,
                          name = "Curve") +
    theme(aspect.ratio = 0.5) +
    ggtitle(paste0("Gauge and ", toupper(names(products)[s]), " ",
                   "estimated rain day frequency (rain days/day) at various thresholds"))
  ##! Figures zm_markov_zero_tamsat, zm_markov_zero_chirps 
  ##! and zm_markov_zero_era5 (Section 4.3.2.2)
  ggsave(here("results", 
              paste0("zambia_", "markov_zero", "_product_", names(products)[s], ".png")),
         plot = g, width = 12, height = 6)
}
```

```{r markov_chain_plots_products_all}
# NOT USED
# types <- c("Gauge > 0.85mm", "Estimate > 0.85mm",
#            "Estimate > 2mm", "Estimate > 3mm",
#            "Estimate > 4mm", "Estimate > 5mm")
# dat <- predict_stack_all %>% 
#   filter(!grepl("max", type)) %>%
#   mutate(product2 = toupper(substr(product2, 1, nchar(product2) - 5)),
#          product2 = factor(product2, levels = c("CHIRPS", "ERA5", "TAMSAT", "IMERG", "RFE2")))
# g <- ggplot(dat, aes(x = s_doy_date, y = prob, 
#                      colour = type, size = type, linetype = type)) +
#   geom_line() +
#   facet_grid(product2~station) +
#   scale_color_manual(values = c("black", viridis(5, end = 0.8)),
#                      labels = types, name = "Curve") +
#   scale_size_manual(values = c(1.3, rep(0.8, 5)), labels = types, name = "Curve") +
#   scale_x_date(date_breaks = "2 months", date_labels = "%b", name = "Date") +
#   scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), name = "Rain day frequency (rain days/day)") +
#   scale_linetype_manual(values = c("solid", rep("longdash", 5)), labels = types,
#                         name = "Curve") +
#   theme(aspect.ratio = 0.5) +
#   ggtitle(paste0("Gauge and Estimates ",
#                 "estimated rain day frequency (rain days/day) at various thresholds"))
# ggsave(here("results",  
#             paste0("zambia_", "markov_zero", "_all_products.png")),
#        plot = g, width = 12, height = 6)
```

## First Order Markov Chain models

```{r markov_chain_setup}
zambia_markov <- zm_long_st %>% 
  filter(!is.na(rain) & !is.na(pr_rain)) %>%
  mutate(rainday1 = rain > 0.85,
         pr_rainday1 = pr_rain > 0.85,
         pr_rainday2 = pr_rain > 2,
         pr_rainday3 = pr_rain > 3,
         pr_rainday4 = pr_rain > 4,
         pr_rainday5 = pr_rain > 5,
         lag1 = factor(ifelse(dplyr::lag(rainday1, 1), "w", "d")),
         pr_lag1 = factor(ifelse(dplyr::lag(pr_rainday1, 1), "w", "d")),
         pr_lag2 = factor(ifelse(dplyr::lag(pr_rainday2, 1), "w", "d")),
         pr_lag3 = factor(ifelse(dplyr::lag(pr_rainday3, 1), "w", "d")),
         pr_lag4 = factor(ifelse(dplyr::lag(pr_rainday4, 1), "w", "d")),
         pr_lag5 = factor(ifelse(dplyr::lag(pr_rainday5, 1), "w", "d"))
         )

f_first_order_station <- rainday1 ~ ((cos(s_doy * 1 * 2 * pi/366) +
                                       sin(s_doy * 1 * 2 * pi/366) +
                                       cos(s_doy * 2 * 2 * pi/366) +
                                       sin(s_doy * 2 * 2 * pi/366) +
                                       cos(s_doy * 3 * 2 * pi/366) +
                                       sin(s_doy * 3 * 2 * pi/366)) * lag1)

f_first_order_product <- pr_rainday1 ~ ((cos(s_doy * 1 * 2 * pi/366) +
                                       sin(s_doy * 1 * 2 * pi/366) +
                                       cos(s_doy * 2 * 2 * pi/366) +
                                       sin(s_doy * 2 * 2 * pi/366) +
                                       cos(s_doy * 3 * 2 * pi/366) +
                                       sin(s_doy * 3 * 2 * pi/366)) * pr_lag1)

predict_stack_lst <- list()
for(s in seq_along(stations)) {
  predict_df <- expand.grid(station = stations[s], s_doy = 1:366, wd = c("d", "w"))
  predict_df$s_doy_date = as.Date(predict_df$s_doy, origin = as.Date("1999/07/31"))
  dat <- zambia_markov %>%
    filter(station == stations[s])
  for(i in seq_along(products)) {
    dat_prod <- dat %>%
      filter(product %in% c("station", products[i])) %>% 
      filter(!is.na(rain) & !is.na(pr_rain))
    first_order_station <- glm(f_first_order_station, data = dat_prod, family = binomial)
    first_order_product <- glm(f_first_order_product, data = dat_prod, family = binomial)
    # print(anova(first_order_station, test = "Chisq"))
    names(predict_df)[3] <- "lag1"
    predict_df[[paste0("station", "_", products[i])]] <- predict(first_order_station, 
                                                                 newdata = predict_df, 
                                                                 type = "response")
    names(predict_df)[3] <- "pr_lag1"
    predict_df[[products[i]]] <- predict(first_order_product, newdata = predict_df, 
                                         type = "response")

    f_first_order_product_2thres <- pr_rainday2 ~ ((cos(s_doy * 1 * 2 * pi/366) +
                                       sin(s_doy * 1 * 2 * pi/366) +
                                       cos(s_doy * 2 * 2 * pi/366) +
                                       sin(s_doy * 2 * 2 * pi/366) +
                                       cos(s_doy * 3 * 2 * pi/366) +
                                       sin(s_doy * 3 * 2 * pi/366)) * pr_lag2)
    f_first_order_product_3thres <- pr_rainday3 ~ ((cos(s_doy * 1 * 2 * pi/366) +
                                       sin(s_doy * 1 * 2 * pi/366) +
                                       cos(s_doy * 2 * 2 * pi/366) +
                                       sin(s_doy * 2 * 2 * pi/366) +
                                       cos(s_doy * 3 * 2 * pi/366) +
                                       sin(s_doy * 3 * 2 * pi/366) * pr_lag3))
    f_first_order_product_4thres <- pr_rainday4 ~ ((cos(s_doy * 1 * 2 * pi/366) +
                                       sin(s_doy * 1 * 2 * pi/366) +
                                       cos(s_doy * 2 * 2 * pi/366) +
                                       sin(s_doy * 2 * 2 * pi/366) +
                                       cos(s_doy * 3 * 2 * pi/366) +
                                       sin(s_doy * 3 * 2 * pi/366) * pr_lag4))
    f_first_order_product_5thres <- pr_rainday5 ~ ((cos(s_doy * 1 * 2 * pi/366) +
                                       sin(s_doy * 1 * 2 * pi/366) +
                                       cos(s_doy * 2 * 2 * pi/366) +
                                       sin(s_doy * 2 * 2 * pi/366) +
                                       cos(s_doy * 3 * 2 * pi/366) +
                                       sin(s_doy * 3 * 2 * pi/366) * pr_lag5))
    fms_thres <- list(f_first_order_product_2thres, f_first_order_product_3thres,
                      f_first_order_product_4thres, f_first_order_product_5thres)
    mds <- list()
    for(j in seq_along(fms_thres)) {
      first_order <- glm(fms_thres[[j]], data = dat_prod, family = binomial)
      names(predict_df)[3] <- paste0("pr_lag", j + 1)
      predict_df[[paste0(products[i], "_", j + 1, "thres")]] <- predict(first_order,
                                                                    newdata = predict_df,
                                                                    type = "response")
    }
  }
  names(predict_df)[3] <- "lag1"
  predict_stack <- predict_df %>% melt(id.vars = c("station", "s_doy", "s_doy_date", "lag1"), 
                                       variable.name = "product", value.name = "prob")

  predict_stack$product <- as.character(predict_stack$product)
  predict_stack$product2 <- predict_stack$product
  predict_stack$type <- "product1"

  predict_stack <- predict_stack %>%
    mutate(type = ifelse(startsWith(product, "station"), "station1", type),
           type = ifelse(endsWith(product, "max"),
                         substr(product, nchar(product) - 3, nchar(product)), type),
           type = ifelse(endsWith(product, "thres"),
                         substr(product, nchar(product) - 5, nchar(product)), type),
           product2 = ifelse(startsWith(product, "station"),
                             substr(product, 9, nchar(product)), product2),
           product2 = ifelse(endsWith(product, "max"),
                             substr(product, 1, nchar(product) - 5), product2),
           product2 = ifelse(endsWith(product, "thres"),
                             substr(product, 1, nchar(product) - 7), product2)
           )

  predict_stack$type <- factor(predict_stack$type, levels = unique(predict_stack$type))
  predict_stack_lst[[length(predict_stack_lst) + 1]] <- predict_stack
}
predict_stack_all <- bind_rows(predict_stack_lst)
predict_stack_all$station <- factor(predict_stack_all$station, levels = stations)
```

```{r markov_chain_first_plots_products}
thres <- c(0.85, 2, 3, 4, 5)
names_thres <- c("product1", paste0(2:5, "thres"))
for (i in seq_along(thres)) {
  for(s in seq_along(products)) {
    curve_labs <- paste0(c("", rep(toupper(names(products)[s]), 5)), types)
    dat <- predict_stack_all %>%
      filter(product2 == products[s] & type %in% c("station1", names_thres[i]) & s_doy %in% 92:274)
    g <- ggplot(dat, aes(x = s_doy_date, y = prob,
                         colour = lag1, linetype = type)) +
      geom_line() +
      facet_wrap(~station) +
    # scale_color_manual(values = c("black", viridis(5, end = 0.8)),
    #                    labels = curve_labs, name = "Curve") +
    #scale_size_manual(values = c(1.3, rep(0.8, 5)), labels = curve_labs, name = "Curve") +
      scale_x_date(breaks = seq.Date(as.Date("1999/11/1"), as.Date("2000/5/1"), by = "2 months"), 
                   date_labels = "%b", name = "Date") +
      scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), name = "Rain day frequency (rain days/day)") +
      scale_linetype_manual(values = c("solid", "longdash")) +
      theme(aspect.ratio = 1) +
      ggtitle(paste0("Gauge and ", toupper(names(products)[s]), " ",
                     "estimated rain day frequency (rain days/day)"))
    
    ##! Figures zm_markov_first_chirps_0.85, zm_markov_first_tamsat_0.85
    ##! and zm_markov_first_tamsat_4 (Section 4.3.2.3)
    ggsave(here("results",
                paste0("zambia_", "markov_first", "_product_", thres[i], "_", names(products)[s], ".png")),
           plot = g, width = 12, height = 6)
  }
}
```

```{r markov_chain_first_dry_spell_plots}
# NOT USED
# for(s in seq_along(products)) {
#   curve_labs <- paste0(c("", rep(toupper(names(products)[s]), 5)), types)
#   dat <- predict_stack_all %>%
#     filter(product2 == products[s] & lag1 == "w")
#   g <- ggplot(dat, aes(x = s_doy_date, y = prob,
#                        colour = type, size = type, linetype = type)) +
#     geom_line() +
#     facet_wrap(~station) +
#     scale_color_manual(values = c("black", viridis(5, end = 0.8)),
#                        labels = curve_labs, name = "Curve") +
#     scale_size_manual(values = c(1.3, rep(0.8, 5)), labels = curve_labs, name = "Curve") +
#     scale_x_date(date_breaks = "2 months", date_labels = "%b", name = "Date") +
#     scale_y_continuous(breaks = seq(0, 1, 0.2), name = "Rain day frequency (rain days/day)") +
#     scale_linetype_manual(values = c("solid", rep("longdash", 5)), labels = curve_labs,
#                           name = "Curve") +
#     ggtitle(paste0("Gauge and ", toupper(names(products)[s]), " ",
#                    "estimated rain day frequency (rain days/day) at various thresholds"))
#   ggsave(here("results", 
#               paste0("zambia_", "markov_first_wet_spell", "_product_", names(products)[s], ".png")),
#          plot = g, width = 12, height = 6)
# }
```

## Rain intensity categories
```{r rain_cats}
cat_labs <- c("Dry", "Light Rain", 
              "Moderate Rain", "Heavy Rain", 
              "Violent Rain")
zm_cats <- zm_long_st %>%
  mutate(rain_cats = cut(rain, c(0, 0.85, 5, 20, 40, Inf), include.lowest = TRUE,
                         right = FALSE, labels = cat_labs),
         pr_rain_cats = cut(pr_rain, c(0, 0.85, 5, 20, 40, Inf), include.lowest = TRUE,
                         right = FALSE, labels = cat_labs))
```

```{r rain_cats_overall}
# NOT USED
# zm_acc_all <- zm_cats %>%
#   group_by(station, product) %>%
#   summarise(accuracy = mean(rain_cats == pr_rain_cats, na.rm = TRUE))
# 
# zm_acc_all %>% 
#   mutate(product = toupper(substr(product, 1, nchar(as.character(product)) - 5))) %>%
#   pivot_wider(id_cols = "station", names_from = "product", values_from = "accuracy") %>%
#   kable(digits = 2) %>%
#   skable()
```

```{r rain_cats_each}
zm_acc_each <- zm_cats %>%
  group_by(station, product, rain_cats) %>%
  filter(!is.na(rain_cats)) %>%
  summarise(n = n(),
            accuracy = mean(rain_cats == pr_rain_cats, na.rm = TRUE))

ggplot(zm_acc_each, aes(x = rain_cats, y = accuracy, fill = product, group = product)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c25[1:5], 
                    labels = c("CHIRPS", "ERA5", "TAMSAT", "IMERG", "RFE2")) +
  labs(x = "Rainfall Intensity categories (mm/day)", y = "Probability of detection") +
  theme(axis.text.x = element_text(size = 8)) +
  labs(fill = "Product") +
  facet_wrap(~station)

##! Figures zm_cats (Section 4.3.2.4)
ggsave(here("results", 
            paste0("zambia_", "rain_cats.png")),
       width = 12, height = 6)
```

## Adjust thresholds

```{r calc_adjust_threshold}
zm_long_st <- zm_long_st %>%
  mutate(season = ifelse(as.character(month) %in% 5:10, "Dry", 
                         as.character(month)),
         season = factor(season, levels = c("Dry", 11:12, 1:4), 
                         labels = c("Dry", month.abb[c(11:12, 1:4)])),
         product = toupper(substr(product, 1, nchar(as.character(product)) - 5)),
         product = factor(product, levels = c("CHIRPS", "ERA5", "TAMSAT", "IMERG", "RFE2"))
         )

thresh_month <- zm_long_st %>%
  mutate(st_wd0p85 = rain > 0.85) %>%
  filter(!is.na(rain) & !is.na(pr_rain)) %>%
  group_by(product, station, season) %>%
  summarise(prob = mean(st_wd0p85), 
            thres_m = quantile(pr_rain, 1 - prob))

thresh_product <- zm_long_st %>%
  mutate(st_wd0p85 = rain > 0.85) %>%
  filter(!is.na(rain) & !is.na(pr_rain)) %>%
  group_by(product, season) %>%
  summarise(prob = mean(st_wd0p85), 
            thres_y = quantile(pr_rain, 1 - prob))

ggplot(thresh_month, aes(x = season, y = thres_m, group = station, colour = station)) +
  geom_line() +
  geom_hline(yintercept = 0.85, colour = "black", linetype = "longdash") +
  geom_line(data = thresh_product, aes(x = season, y = thres_y, group = 1), 
            inherit.aes = FALSE, colour = "black", size = 0.8) +
  scale_color_manual(values = c25[1:7]) +
  scale_y_continuous(breaks = seq(0, 8, 1)) +
  labs(x = "Month", y = "Threshold (mm)", group = "Location", colour = "Location") +
  facet_wrap(~product)
##! Figure zm_thresh_adjust (Section: 4.3.3)
ggsave(here("results",  
            paste0("zambia_", "thres_adjust.png")),
       width = 12, height = 6)

```

```{r apply_adjust_threshold}
# Not used in paper
# thresh_month <- thresh_month %>%
#   mutate(thres_m = max(0.85, thres_m))
# 
# zm_long_adj <- zm_long %>% 
#   mutate(season = ifelse(as.character(month) %in% 5:10, "Dry", 
#                          as.character(month)),
#          season = factor(season, levels = c("Dry", 11:12, 1:4), 
#                          labels = c("Dry", month.abb[c(11:12, 1:4)])),
#          product = as.character(product),
#          product = ifelse(product != "station", 
#                           toupper(substr(product, 1, nchar(as.character(product)) - 5)),
#                           product),
#          product = factor(product, 
#                           levels = c("station", "CHIRPS", "ERA5", "TAMSAT",
#                                      "IMERG", "RFE2"))) %>%
#   left_join(thresh_month, by = c("product", "station", "season")) %>%
#   mutate(thres_m = ifelse(product == "station", 0.85, thres_m))
# 
# by_syear_adj <- zm_long_adj %>%
#   group_by(station, syear, product) %>%
#   summarise(total_rain = sum(naif_nmin(rain, 355)), 
#             n_rain = sum(naif_nmin(rain > 0.85, 355)),
#             n_rain_t = sum(naif_nmin(rain > thres_m, 355)),
#             mean_rain_t = total_rain/n_rain_t,
#             mean_rain = total_rain/n_rain,
#             n_na = sum(is.na(rain))
#             )
# 
# by_syear_st_adj <- by_syear_adj %>%
#   pivot_wider(id_cols = c(station, syear), 
#               names_from = product, values_from = total_rain:n_na, 
#               names_sep = "__") %>%
#   pivot_longer(cols = -c(station, syear, ends_with("station")), 
#                names_to = c(".value", "product"), names_sep = "__")
# 
# gof_syear_adj <- by_syear_st_adj %>%
#   group_by(station, product) %>%
#   nest() %>%
#   mutate(n = purrr::map_int(data, 
#                         ~sum(!is.na(.$total_rain__station) 
#                              & !is.na(.$total_rain))),
#          gof__total_rain = purrr::map(data, dgof, "total_rain", 
#                                       "total_rain__station", na.rm = TRUE),
#          gof__n_rain = purrr::map(data, dgof, "n_rain", "n_rain__station", 
#                                   na.rm = TRUE),
#          gof__mean_rain = purrr::map(data, dgof, "mean_rain", 
#                                      "mean_rain__station", na.rm = TRUE),
#          gof__n_rain_t = purrr::map(data, dgof, "n_rain_t", "n_rain__station",
#                                     na.rm = TRUE),
#          gof__mean_rain_t = purrr::map(data, dgof, "mean_rain_t",
#                                        "mean_rain__station", na.rm = TRUE)
#          )
# 
# gof_pr_adj <- gof_syear_adj %>% 
#   unnest(cols = data) %>% 
#   group_by(product) %>% 
#   nest()
```

```{r liv_yearly_n_rain_plots_adj}
# Not used in paper
# liv_year_adj <- gof_pr_adj %>% 
#   unnest(data) %>%
#   filter(station == "Livingstone") %>%
#   select(product, station, syear, n_rain__station, n_rain_t, n_rain) %>%  
#   mutate(n_rain__station = ifelse(is.na(n_rain_t), NA, n_rain__station),
#          n_rain_t = ifelse(is.na(n_rain__station), NA, n_rain_t),
#          n_rain = ifelse(is.na(n_rain__station), NA, n_rain)) %>%
#   pivot_longer(cols = c("n_rain__station", "n_rain_t", "n_rain"), 
#                names_to = "Source", values_to = "n_rain") %>%
#   ungroup() %>%
#   mutate(Source = forcats::fct_recode(Source, 
#                                       Gauge = "n_rain__station", Estimate = "n_rain_t",
#                                       `Estimate unadjusted` = "n_rain"),
#          Source = factor(Source, levels = c("Gauge", "Estimate", "Estimate unadjusted")))
# 
# mean_df <- liv_year_adj %>%
#   group_by(product, Source) %>%
#   summarise(m = mean(n_rain, na.rm = TRUE))
# 
# g <- ggplot(liv_year_adj, aes(x = syear, y = n_rain, colour = Source)) +
#   geom_line() +
#   geom_point() +
#   geom_hline(data = mean_df, aes(yintercept = m, colour = Source)) +
#   scale_x_continuous(breaks = seq(1980, 2020, 5)) +
#   scale_y_continuous(limits = c(0, NA), breaks = seq(0, 150, 25)) +
#   labs(x = "Year", y = "Rain day frequency (rain day/year)") +
#   ggtitle("Gauge vs estimate August to July rain day frequency at Livingstone") +
#   facet_wrap(~product)
# 
# ggsave(here("results", paste0("zambia_", "livingstone_",
#                               "n_rain_adj", ".png")),
#        width = 12, height = 6)
```

```{r adj_thresh_cor}
# Not used in paper
# cor_by_year <- by_syear_st_adj %>%
#   group_by(product, station) %>%
#   summarise(cor_pr = cor(x = n_rain__station, y = n_rain, use = "na.or.complete"),
#             cor_pr_t = cor(x = n_rain__station, y = n_rain_t, use = "na.or.complete"),
#             cor_pr_pr_t = cor(x = n_rain, y = n_rain_t, use = "na.or.complete")) %>%
#   ungroup()
# 
# cor_by_year_stack <- cor_by_year %>%
#   pivot_longer(cols = c("cor_pr", "cor_pr_t"))
# 
# g <- ggplot(cor_by_year_stack, aes(x = station, y = value, fill = name)) +
#   geom_col(position = "dodge") +
#   labs(x = "Location", y = "Correlation", fill = "Estimate") +
#   scale_fill_manual(values = c25[1:2], labels = c("Unadjusted", "Adjusted threshold")) +
#   facet_wrap(~product)
# 
# ggsave(here("results", paste0("zambia_", "n_rain_adj_cor", ".png")),
#        width = 12, height = 6)

```

```{r liv_yearly_n_rain_tables_adj, results="asis"}
# Not used in paper
# df <- gof_syear_adj %>%
#   filter(station == "Livingstone") %>%
#   ungroup() %>%
#   mutate(r = purrr::map_dbl(gof__n_rain_t, "r"),
#          pbias = purrr::map_dbl(gof__n_rain_t, "PBIAS %"),
#          MAE = purrr::map_dbl(gof__n_rain_t, "MAE")) %>%
#   pivot_longer(cols = c("r", "pbias", "MAE"), names_to = "metric") %>%
#   mutate(metric = factor(metric, levels = c("r", "pbias", "MAE"))) %>%
#   select(station, product, metric, value) %>%
#   mutate(value = ifelse(metric == "r", format(value, digits = 2), 
#                         round(value))) %>%
#   pivot_wider(names_from = "product", values_from = "value") %>%
#   arrange(metric, station)
# # names(df)[3:ncol(df)] <- toupper(substr(names(df)[3:ncol(df)], 1, 
# #                                         nchar(names(df)[3:ncol(df)]) - 5))
# df %>% 
#   select(metric, CHIRPS, ERA5, TAMSAT, IMERG, RFE2) %>%
#   kable() %>%
#   column_spec(column = 4, border_right = TRUE) %>%
#   collapse_rows(columns = 1) %>%
#   skable()
```

## Start of the rains

```{r start_rains_graphs}
# Not used in paper
# zm_year_rain <- zm_long_st %>%
#   group_by(product, station) %>%
#   mutate(roll_sum_rain = RcppRoll::roll_sumr(x = rain, n = 3, fill = NA, na.rm = FALSE)) %>%
#   filter((rain >= 0.85 & roll_sum_rain > 20) | is.na(rain) | is.na(roll_sum_rain)) %>%
#   group_by(product, station, syear) %>%
#   filter(s_doy >= 107 & s_doy <= 213) %>%
#   summarise(start_rain_doy = ifelse(is.na(dplyr::first(rain)) | is.na(dplyr::first(roll_sum_rain)),
#                                     NA, dplyr::first(s_doy))
#             )
# 
# zm_year_pr_rain <- zm_long_st %>%
#   group_by(product, station) %>%
#   mutate(roll_sum_pr_rain = RcppRoll::roll_sumr(x = pr_rain, n = 3, fill = NA, na.rm = FALSE)) %>%
#   filter((pr_rain >= 0.85 & roll_sum_pr_rain > 20) | is.na(pr_rain) | is.na(roll_sum_pr_rain)) %>%
#   group_by(product, station, syear) %>%
#   filter(s_doy >= 107 & s_doy <= 213) %>%
#   summarise(start_pr_rain_doy = ifelse(is.na(dplyr::first(pr_rain)) | is.na(dplyr::first(roll_sum_pr_rain)),
#                                        NA, dplyr::first(s_doy))
#             )
# 
# zm_year_rain <- full_join(zm_year_rain, zm_year_pr_rain, 
#                           by = c("product", "station", "syear"))
# 
# product_names <- c("CHIRPS", "ERA5", "TAMSAT", "IMERG", "RFE2")
# for (p in seq_along(product_names)) {
#   df <- zm_year_rain %>% dplyr::filter(product == product_names[[p]])
#   g <- ggplot(df, aes(x = syear, y = start_rain_doy)) +
#     geom_line(aes(colour = "station")) +
#     geom_line(aes(y = start_pr_rain_doy, colour = "product")) +
#     ggtitle(paste0(products[[p]], ": Start of rains")) +
#     facet_wrap(~station)
#   print(g)
# }
```

```{r start_rains_metrics}
# Not used in paper
# zm_year_metrics <- zm_year_rain %>%
#   group_by(product, station) %>%
#   summarise(r = cor(start_pr_rain_doy, start_rain_doy, use = "na.or.complete"),
#             me = hydroGOF::me(start_pr_rain_doy, start_rain_doy),
#             mae = hydroGOF::mae(start_pr_rain_doy, start_rain_doy),
#             rSD = hydroGOF::rSD(start_pr_rain_doy, start_rain_doy)#,
#             #prop_after = sum(start_pr_rain_doy > start_rain_doy, na.rm = TRUE)/n()
#             )
# 
# df <- zm_year_metrics %>%
#   mutate(r = as.character(round(r, 2)),
#          me = as.character(round(me, 1)),
#          mae = as.character(round(mae, 1)),
#          rSD = as.character(round(rSD, 2))) %>%
#   pivot_longer(cols = c("r", "me", "mae", "rSD"), names_to = "metric") %>%
#   mutate(metric = factor(metric, levels = c("r", "me", "mae", "rSD"))) %>%
#   select(station, product, metric, value) %>%
#   mutate(value = ifelse(metric == "pbias", format(value, digits = 0), 
#                         format(value, digits = 2))) %>%
#   pivot_wider(names_from = "product", values_from = "value") %>%
#   arrange(metric, station)
# # names(df)[3:ncol(df)] <- toupper(substr(names(df)[3:ncol(df)], 1, 
# #                                         nchar(names(df)[3:ncol(df)]) - 5))
# df %>% 
#   select(metric, station, CHIRPS, ERA5, TAMSAT, IMERG, RFE2) %>%
#   kable() %>%
#   column_spec(column = 5, border_right = TRUE) %>%
#   collapse_rows(columns = 1) %>%
#   skable()
```

```{r start_rains_dry_graphs}

# Not used in paper
# zm_year_rain_dry <- zm_long_st %>%
#   group_by(product, station) %>%
#   mutate(roll_sum_rain = RcppRoll::roll_sumr(x = rain, n = 3, fill = NA, na.rm = FALSE),
#          dry_spell = .spells(rain <= 0.85),
#          roll_max_dry_spell = dplyr::lead(RcppRoll::roll_maxl(dry_spell, n = 30, fill = NA))) %>%
#   filter((rain >= 0.85 & roll_sum_rain > 20 & roll_max_dry_spell <= 10) | 
#            is.na(rain) | is.na(roll_sum_rain) | is.na(roll_max_dry_spell)) %>%
#   group_by(product, station, syear) %>%
#   filter(s_doy >= 107 & s_doy <= 213) %>%
#   summarise(start_rain_doy_dry = ifelse(is.na(dplyr::first(rain)) | is.na(dplyr::first(roll_sum_rain)) |
#                                           is.na(dplyr::first(roll_max_dry_spell)),
#                                         NA, dplyr::first(s_doy))
#             )
# 
# zm_year_pr_rain_dry <- zm_long_st %>%
#   group_by(product, station) %>%
#   mutate(roll_sum_rain = RcppRoll::roll_sumr(x = pr_rain, n = 3, fill = NA, na.rm = FALSE),
#          dry_spell = .spells(pr_rain <= 0.85),
#          roll_max_dry_spell = dplyr::lead(RcppRoll::roll_maxl(dry_spell, n = 30, fill = NA))) %>%
#   filter((pr_rain >= 0.85 & roll_sum_rain > 20 & roll_max_dry_spell <= 10) | 
#            is.na(pr_rain) | is.na(roll_sum_rain) | is.na(roll_max_dry_spell)) %>%
#   group_by(product, station, syear) %>%
#   filter(s_doy >= 107 & s_doy <= 213) %>%
#   summarise(start_pr_rain_doy_dry = ifelse(is.na(dplyr::first(pr_rain)) | is.na(dplyr::first(roll_sum_rain)) |
#                                           is.na(dplyr::first(roll_max_dry_spell)),
#                                         NA, dplyr::first(s_doy))
#             )
# 
# zm_year_raindry <- full_join(zm_year_rain_dry, zm_year_pr_rain_dry,
#                              by = c("product", "station", "syear"))
# 
# for (p in seq_along(products)) {
#   df <- zm_year_raindry %>% dplyr::filter(product == products[[p]])
#   g <- ggplot(df, aes(x = syear, y = start_rain_doy_dry)) +
#     geom_line(aes(colour = "station")) +
#     geom_line(aes(y = start_pr_rain_doy_dry, colour = "product")) +
#     ggtitle(paste0(products[[p]], ": Start of rains with dry spell condition")) +
#     facet_wrap(~station)
#   print(g)
# }
```

```{r start_rainsdry_metrics}
# Not used in paper
# zm_year_metrics_dry <- zm_year_raindry %>%
#   group_by(product, station) %>%
#   summarise(r = cor(start_pr_rain_doy_dry, start_rain_doy_dry, use = "na.or.complete"),
#             me = hydroGOF::me(start_pr_rain_doy_dry, start_rain_doy_dry),
#             mae = hydroGOF::mae(start_pr_rain_doy_dry, start_rain_doy_dry),
#             rSD = hydroGOF::rSD(start_pr_rain_doy_dry, start_rain_doy_dry),
#             prop_after = sum(start_pr_rain_doy_dry > start_rain_doy_dry, na.rm = TRUE)/n()
#             )
# 
# df <- zm_year_metrics %>%
#   pivot_longer(cols = c("r", "me", "mae", "rSD", "prop_after"), names_to = "metric") %>%
#   mutate(metric = factor(metric, levels = c("r", "me", "mae", "rSD", "prop_after"))) %>%
#   select(station, product, metric, value) %>%
#   mutate(value = ifelse(metric == "pbias", format(value, digits = 0), 
#                         format(value, digits = 2))) %>%
#   pivot_wider(names_from = "product", values_from = "value") %>%
#   arrange(metric, station)
# names(df)[3:ncol(df)] <- toupper(substr(names(df)[3:ncol(df)], 1, 
#                                         nchar(names(df)[3:ncol(df)]) - 5))
# df %>% 
#   select(metric, station, CHIRPS, ERA5, TAMSAT, IMERG, RFE2) %>%
#   kable() %>%
#   column_spec(column = 5, border_right = TRUE) %>%
#   collapse_rows(columns = 1) %>%
#   skable()
```

```{r start_rains_compare}
# Not used in paper
# df1 <- zm_year_rain %>% dplyr::filter(product == products[[1]])
# df2 <- zm_year_raindry %>% dplyr::filter(product == products[[1]])
# g <- ggplot(df1, aes(x = syear, y = start_rain_doy)) +
#   geom_line(aes(colour = "standard")) +
#   geom_line(aes(y = start_rain_doy_dry, colour = "with dry spell"), df2) +
#   ggtitle(paste0(products[[p]], ": Start of rains")) +
#   facet_wrap(~station)
# print(g)
```

```{r start_metrics_compare}
# Not used in paper
# zm_metrics_bind <- dplyr::bind_rows(standard = zm_year_metrics, dry = zm_year_metrics_dry, .id = "type")
# zm_metrics_bind$type <- factor(zm_metrics_bind$type, levels = c("standard", "dry"))
# ggplot(zm_metrics_bind, aes(x = station, y = mae, fill = type)) +
#   geom_col(position = "dodge") +
#   facet_wrap(~product)
```
